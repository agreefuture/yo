use "std/array";


struct String {
    _backing: ref i8
};

impl String {
    fn length(self: String): int {
        return runtime::_strlen(self._backing);
    }


    fn appending(self: String, other: String): String {
        return String::format("%s%s", self, other);
        //val self_length = self.length();
        //val other_length = other.length();
        //val newLength: int = self_length + other_length;

        //val newBacking: int = runtime::alloc(newLength + 1);
        //newBacking[0] = newLength;

        //runtime::copy_array(self._backing, 1, newBacking, 1, self_length);
        //runtime::copy_array(other._backing, 1, newBacking, self_length + 1, other_length);

        //ret String::init(newBacking);

    }

    fn copy(self: String): String {
        return String::format("%s", self);
        //val length = self.length() + 1;

        //val newBacking = runtime::alloc(length);
        //runtime::copy_array(self._backing, 0, newBacking, 0, length);

        //ret String::init(newBacking);
    }

    fn hashValue(self: String): int {
        return runtime::_hashString(self);
    }


    fn isEqualToString(self: String, other: String): bool {
        if self as i64 == other as i64 {
            return true;
        }

        if self.length() != other.length() {
            return false;
        }

        //for i in 0..<self.length() {
        let length = self.length();
        for let i = 0; i < length; i += 1; {
            if self._backing[i] != other._backing[i] {
                return false;
            }
        }
        return true;
    }

    fn isEqualTo(self: String, other: id): bool {
        // Make sure borh are strings
        if runtime::typeof(self) != runtime::typeof(other) {
            return false;
        }
        return self.isEqualToString(other);
    }


    fn description(self: String): String {
        return self;
    }

    fn debugDescription(self: String): String {
        return String::init(runtime::_stringDebugDescription(self));
    }


    fn dealloc(self: String): void {
        runtime::free(self._backing as int);
    }


    #[variadic]
    static fn format(format: String, args: Array): String {
        return String::format_v(format, args);
    }


    static fn format_v(format: String, args: Array): String {
        return String::init(runtime::__format(format, args));
    }
}
